---
title: "Day 4 - Linear Regression"
author: "Zhaoxia Yu, Department of Statistics, University of California, Irvine"
date: "`r Sys.Date()`"
format: 
  revealjs:
    theme: "sky"
    slideNumber: true
    transition: "fade"
    progress: true
    controls: true
    code-fold: true
    echo: true
    fig-align: center
---


## Load Libraries
```{r}
library(ggplot2)
library(tidyverse)
```

## Read Data
```{r}
alzheimer_data <- read.csv('data/alzheimer_data.csv') %>% 
  select(id, diagnosis, age, educ, female, height, weight, lhippo, rhippo) %>% 
  mutate(diagnosis = as.factor(diagnosis), female = as.factor(female))


alzheimer_healthy <- read.csv('data/alzheimer_data.csv') %>% 
  select(id, diagnosis, age, educ, female, height, weight, lhippo, rhippo) %>% 
  mutate(diagnosis = as.factor(diagnosis), female = as.factor(female)) %>% filter(diagnosis==0)

#define a new variable
#note: today we use the sum as the total hippocampal volume
alzheimer_healthy$hippo = alzheimer_healthy$lhippo + alzheimer_healthy$rhippo

#define the subset of older (>35) healthy subjects
alzheimer_healthy_old = alzheimer_healthy %>% filter(age>35)
#old-fashioned way to do the same thing
#alzheimer_healthy_old = alzheimer_healthy[alzheimer_healthy$age >35,]

```


# Introduction

## Review: Example 6 of Day 3
- **Research Question**: Is hippocampus volume correlated with age in healthy adults?

- **Null Hypothesis**: hippocampus volume and age are not correlated.
- **Alternative Hypothesis**: hippocampus volume and age are not correlated.

$$H_0: \rho=0 \mbox{ vs } H_1: \rho\not=0$$

- Method: correlation test, more general, linear regression.

## Linear Relationship 
```{r}
#| fig-align: center

#plot(alzheimer_healthy$age, alzheimer_healthy$hippo, xlab="age", ylab="hippo")

ggplot(alzheimer_healthy, aes(x=age, y=hippo)) +
  geom_point() + 
  labs(x = "age", y="hippo volume", title="hippo volume vs age")
```

- The relationship is roughly (negatively) linear except for age <40. 

## Example: left vs right hippocampus
```{r}
#| fig-align: center
ggplot(alzheimer_healthy, aes(x=lhippo, y=rhippo)) +
  geom_point() + 
  labs(x = "left hippo", y="right hippo", title="hippo volume")


```

## Correlation and Linear Regression
```{r}
#| fig-align: center

par(mfrow=c(1,2))
plot(alzheimer_healthy$lhippo, alzheimer_healthy$rhippo,
     xlab = "left hippo", ylab="right hippo", main="hippo volume")
plot(alzheimer_healthy$weight, alzheimer_healthy$hippo,
     xlab = "weight", ylab="hippo", main="hippo vs weight")

```

## Correlation vs Linear Regression
- Correlation is a measure of the strength of **linear** relationship between two continuous variables. 
```{r}
#| fig-align: center
print("correlation between left and right hippo volume")
cor(alzheimer_healthy$lhippo, alzheimer_healthy$rhippo)

print("correlation between weight and hippo volume")
cor(alzheimer_healthy$weight, alzheimer_healthy$hippo)
```

## Why do we need linear regression
- **Interpretation**: What is the expected decrease in hippocampal volume with a one-year increase in age?

- **Account for covariates** using multiple linear regression. Adjust for covariates is particularly important in observational studies. 
  - E.g., association between obesity and gender might be dependent on other factors, such as ethnicity, countries, income, etc


- **Prediction**: What is the predicted hippocampal volume for a 45-yar old healthy woman? 


# Linear Regression 

## The Response Variable
- In a linear model, the **response variable** is the variable that we are trying to predict or explain. 

- A **response variable** is also known as a **dependent variable**.  

- It is the outcome or the variable that is being studied and modeled as a function of one or more **explanatory** (**independent**) variables. 

- We often use $y$ to represent the response variable. 


# Simple Linear Regression (SLM)

## Simple Linear Regression
- Simple linear regression is the regression model with only one explanatory variable. 

- It can be used to assess the **linear relationship** between two variables. Example, age and hippocampal volume in healthy older (35+) subjects


```{r}
#| fig-align: center
ggplot(alzheimer_healthy_old, aes(x=lhippo, y=rhippo)) +
  geom_point() + 
  labs(x = "left hippo", y="right hippo", title="hippo volume")

```

## The Model
::: {style="font-size: 75%;"}
- The linear model is represented as:

$$y=\beta_0 + \beta_1 x + \epsilon$$

  - $y$: Response variable (dependent variable)
  - $x$: Explanatory variable (independent variable)
  - $\beta_0$: Intercept (constant term)
  - $\beta_1$: Slope (rate of change)
  - $\epsilon$: Error term (residuals)

- It is also common to add subject indices
$$y_i=\beta_0 + \beta_1 x_i + \epsilon_i, i=1, \cdots, n$$
:::

## Model Assumptions

-   $y_i=\beta_0 + \beta_1 x_i + \epsilon_i, i=1, \cdots, n$
-   $E(\epsilon_i)=0$
-   The $n$ observations are independent
-   Reasonably large $n$ or normality assumption: $\epsilon_i \sim N(0, \sigma^2)$

## Computation
- Least Squares Estimate: looking for $\hat\beta_0$ and $\hat\beta_1$ that minimizes $\sum_{i=1}^n (y_i - \beta_0 -\beta_1 x_i)^2$. 

- Other notations: 
$$b_0=\hat \beta_0, b_1=\hat\beta_1$$

::: {style="font-size: 100%; color: lightgray"}
- The process of finding $(b_0, b_1)$ involves solving two linear equations jointly. 

    -   $b_0=\hat\beta_0=\bar{y}-b_1\bar{x}$
    -   $b_1=\hat\beta_1=\dfrac{\sum_{i=1}^{n}(x_i-\bar{x})(y_i-
\bar{y})}{\sum_{i=1}^{n}(x_i-\bar{x})^2}$
:::

# Interpretation of Simple Linear Regression

## Example 1: hippo vs age
```{r}
#| fig-align: center
ggplot(alzheimer_healthy_old, aes(x=age, y=hippo)) +
  geom_point() + 
  labs(x = "age", y="hippo", title="hippo vs age")+
   geom_smooth(method='lm', se=FALSE)
```

```{r}
#define an lm object
obj.age.hippo=lm(hippo~age, data=alzheimer_healthy_old)
coef(obj.age.hippo) #alternatively: obj$coefficients
```

## Example 1: interpret the Coefficients


::: {style="font-size: 75%;"}
- The fitted line is $hippo = 8.29 - 0.027 \times age$
- Interpretation of $b_0=8.29$
  - mathematically, it is the estimated  hippocampal value for a person at age 0. 
  - statistically, this interpretation involves  extrapolation, which should be avoided. Rational: 
    - The linear trend we observed is for healthy subjects who are 35 or older. 
    - It is dangerous to assume that the same linear trend holds at around age 0.  

- Interpretation of $b_1= - 0.027$: for each added year, the hippocampal size decreased by 0.027 (cm$^3$).
:::

## Residuals

::: {style="font-size: 100%; color: lightgray"}
-   $e_i = y_i - \hat y_i$ where $\hat y_i = \hat\beta_0 + \hat \beta_1 x_i$
-   Residual sum of squares (RSS): $RSS=\sum_{i=1}^n e_i^2 = \sum_{i=1}^n (y_i -\hat y_i)^2$
-   An unbiased estimate of $\sigma^2$ is $s^2$: $$s^2= \frac{RSS}{n-2}$$
:::

## Standard Error and Confidence Interval

::: {style="font-size: 100%; color: lightgray"}
-   The standard error of $\hat\beta_1$ is $$se(\hat \beta_1)=\frac{\sqrt{s^2}}{\sqrt{\sum (x_i - \bar{x})^2}}$$
:::
-   A $100(1-\alpha)\%$ confidence interval for $\beta_1$ is $$\hat\beta_1 \pm t_{\alpha / 2, n - 2} se(\hat\beta_1)$$


## t and p-value

```{r}
summary(obj.age.hippo)
```
- The estimated slope ($b_1$) is -0.027, its standard error is 0.001712, and the p-value is $<2e-16$; the linear relationship is significant at level 0.05. 


## Confidence Interval
```{r}
confint(obj.age.hippo)
```
- The estimated slope ($b_1$) is -0.027.
- A 95% confidence interval is (-0.031, -0.024). 


## Estimation vs Prediction
- **Question 1**: What is the estimated mean hippocampal volume for 45-year-old women?

```{r}
predict(obj.age.hippo, newdata = data.frame(age=45), interval = 'confidence')
```

- **Question 2**: What is the predicted hippocampal volume for a 45-year-old woman?

```{r}
predict(obj.age.hippo, newdata = data.frame(age=45), interval = 'predict')
```

- Why is the prediction interval wider than the estimation interval?


## Example 2: A Binary X
- Now, consider the relationship between hippocampal volume and gender (the ``female``` variable in the data)


```{r}
#| fig-align: center

ggplot(alzheimer_healthy_old, aes(x=female, y=hippo)) +
  geom_point() + 
  labs(x = "female", y="hippo", title="hippo vs female")+
   geom_smooth(method='lm', se=FALSE)
```

## Boxplots by gender are better 
```{r}
#| fig-align: center

ggplot(alzheimer_healthy_old, aes(x=female, y=hippo, fill=female)) +
  geom_boxplot() + 
  labs(x = "female", y="hippo", title="hippo vs female")
```

## Results and Interpretation

```{r}
summary(lm(hippo ~ female, data=alzheimer_healthy_old))$coefficients
```

::: {style="font-size: 50%"}

- The intercept $b_0=6.7482841$ is the estimated hippocampal volume for men (female=0)

- The slope $b_1=-0.4887882$ is the estimated difference between women and men in hippocampal volume

- Let's verify this using two-sample t-test
:::

```{r}
t.test(hippo~female, data=alzheimer_healthy_old, var.equal =T)
# equivalently, you can use
#t.test(alzheimer_healthy_old$hippo[alzheimer_healthy_old$female==1], alzheimer_healthy_old$hippo[alzheimer_healthy_old$female==0], var.equal =T)
```

# Multiple Linear Regression

## Motivating Example

- Are healthy men and women differ in hippocampus volume?
- We just found that the difference is significant at level 0.05. 

## Can the difference be explained by height?

-   Men have larger hippocampus volume

```{r}
#| fig-align: center
ggplot(alzheimer_healthy_old, aes(x=height, y=hippo, color=female))+geom_point()
```

## The adjusted difference
```{r}
summary(lm(hippo ~ height + female, data=alzheimer_healthy_old))$coefficients
```

- The **adjusted** difference between men and women 

  - has a much smaller difference
  - is less significant

# Linear Models Are a Unified Tool


## Conduct ANOVA Using linear regression
- We have seen how to use linear regression to perform a two-sample t-test
- Linear regression can also be used for ANOVA
- ANOVA using the ``aov`` function
```{r}
summary(aov(lhippo~diagnosis, data=alzheimer_data))
```

## Conduct ANOVA Using linear regression
- ANOVA using two functions: ``lm`` and ``anova``
```{r}
summary(lm(lhippo~diagnosis, data=alzheimer_data))$coefficients
anova(lm(lhippo~diagnosis, data=alzheimer_data))
```

# Advanced Topics

## Outliers
::: {style="font-size: 85%; color: lightgray"}
**Outliers** are points that do not follow the general pattern of the majority of the data.

-   **Leverage points** are also called x-outliers.

-   **Influential Outliers:** These are data points that, when removed, lead to a significant change in the regression model. They can drastically affect the slope and intercept of the regression line.

-   Residuals ($e_i=y_i - \hat y_i, i=1, \cdots, n$) and their standardized versions are often used to visually inspect assumptions.

-   **Outliers** often have large residuals. Residual plots can be used to visually detect these outliers. An observation with a residual significantly larger or smaller than the other residuals may be an outlier.
:::

## Outliers: Examples

![](images/image-1452328645.png){fig-align="center"}

- Suggestions: check and inform, do not delete them automatically

## Model Diagnostics

::: {style="font-size: 85%; color: lightgray"}
-   **Linearity**: The relationship between predictors and response is linear. Violation seen when residuals display a systematic pattern.
-   **Independence**: The residuals are independent. Violation seen when residuals display trends over time or space.
-   **Homoscedasticity**: The variance of the residuals is constant. Violation seen when residuals show a "funnel" shape pattern.
-   **Normality**: The residuals are normally distributed. Violation seen when residuals don't follow a bell-shaped pattern in a histogram or a straight line on a Q-Q plot.
:::

## Interpret Interactions

::: {style="font-size: 100%; color: lightgray"}
-   Do men and women shrink brain in the same speed?

```{r}
#| fig-align: center
ggplot(alzheimer_healthy_old, aes(x=age, y=hippo, color=female))+
  geom_point()+
  geom_smooth(method=lm, se=F)
```
:::

## Interpret Interactions

```{r}
summary(lm(lhippo~ age*female, data=alzheimer_healthy_old))$coefficients
```

::: {style="font-size: 90%; color: lightgray"}
-   The estimated brain shrinking speed for men is 0.017cc per year
-   The estimated brain shrinking speed for women is 0.013cc per year
-   The result about the interaction item indicates that the difference in brain shrinking speed between men and women is 0.005cc per year and it is statistically significant
:::

## Interpret transformed data

::: {style="font-size: 100%; color: lightgray"}
-   Weight is a little bit skewed. Regress hippocampus volume on log(weight). How to interpret the results?

```{r}
#| fig-align: center
#plot(log(alzheimer_healthy_old$weight), alzheimer_healthy_old$hippo, xlab="weight", ylab="log(weight)")
summary(lm(hippo~log(weight), data=alzheimer_healthy_old))$coefficients
```
- $b_1=1.013243$: when weight increases by $(e^{1.013243}-1)*100=175.45%$. 
:::


## Interpret transformed data

::: {style="font-size: 100%; color: lightgray"}
-   Regress log(weight) on height. How to interpret the results?

```{r}
#plot(alzheimer_healthy_old$height, log(alzheimer_healthy_old$weight), xlab="height", ylab="log(weight)")
summary(lm(log(weight)~height, data=alzheimer_healthy_old))$coefficients
```
- $b_1=0.02935588$: when height increases 1 unit, weight will increase by $(e^{0.02935588}-1)*100$=2.98%.
:::

